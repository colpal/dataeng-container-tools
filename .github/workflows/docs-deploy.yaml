name: Build All Package Tags

on:
  push:
    branches:
      - feature/v1-docs

permissions:
  contents: read
  id-token: write

jobs:
  build-all-tags:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install UV
        uses: astral-sh/setup-uv@v6
        with:
          version: "0.8.15"
          python-version: "3.13"
          activate-environment: true
          enable-cache: false

      - id: oidc
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.VAULT_IAP_SA }}
          id_token_audience: ${{ secrets.VAULT_IAP_CLIENT_ID }}
          token_format: id_token
          id_token_include_email: true

      - name: Retrieve secrets from Vault
        id: vault
        uses: hashicorp/vault-action@v3
        with:
          url: ${{ secrets.VAULT_URL }}
          method: jwt
          role: ${{ github.event.repository.name }}
          exportEnv: false
          extraHeaders: "Authorization: Bearer ${{ steps.oidc.outputs.id_token }}"
          secrets: |
            ${{ secrets.VAULT_SECRET_PATH_DOCS }} | password;

      - name: Google Auth
        id: google-auth
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ steps.vault.outputs.password }}
          project_id: ${{ secrets.ARTIFACT_PROJECT_ID}}

      - name: Setup gcloud
        id: setup-gcloud
        uses: google-github-actions/setup-gcloud@v3
        with:
          version: '532.0.0'

      - name: Authorize docker with GCP
        id: auth-image
        shell: bash
        run: gcloud auth configure-docker us-east4-docker.pkg.dev

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: ${{ secrets.ARTIFACT_REGISTRY_LOCATION_DOCS }}:latest
